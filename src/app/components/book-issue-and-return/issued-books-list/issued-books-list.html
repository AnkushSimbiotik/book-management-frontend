<div class="container mt-5">
  <h2>All Issued Books</h2>

  <!-- Search and Sort -->
  <div class="row mb-3">
    <div class="col-md-4">
      <input
        type="text"
        class="form-control"
        [(ngModel)]="searchUserId"
        (keyup.enter)="onSearch()"
        placeholder="Search by User ID"
        appNoLeadingSpace
      />
    </div>
    <div class="col-md-4">
      <input
        type="text"
        class="form-control"
        [(ngModel)]="searchBookId"
        (keyup.enter)="onSearch()"
        placeholder="Search by Book ID"
        appNoLeadingSpace
      />
    </div>
    <div class="col-md-4">
      <select
        class="form-select"
        [(ngModel)]="statusFilter"
        (change)="onSearch()"
      >
        <option value="Issued">Issued</option>
        <option value="Returned">Returned</option>
        <option value="">All Statuses</option>
      </select>
    </div>
  </div>
  <!-- Loading or Error State -->
  <div *ngIf="loading" class="alert alert-info">Loading issued books...</div>
  <div *ngIf="error" class="alert alert-danger">{{ error }}</div>

  <!-- Search Results Feedback -->
  <div *ngIf="searchQuery && !loading && !error" class="alert alert-info">
    <i class="bi bi-search"></i>
    Search results for "{{ searchQuery }}": {{ issuedBooks.length }} book(s)
    found
    <button
      class="btn btn-sm btn-outline-secondary ms-2"
      (click)="clearSearch()"
    >
      Clear Search
    </button>
  </div>

  <!-- Issued Books Table -->
  <div *ngIf="issuedBooks.length > 0" class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>User</th>
          <th>Book</th>
          <th>Issue Date</th>
          <th>Estimated Return</th>
          <th>Status</th>
          <th>Return Date</th>
          <th>Overdue</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let issue of issuedBooks" [class]="getOverdueClass(issue)">
          <td>
            <strong>{{ getUserDisplay(issue) }}</strong>
          </td>
          <td>
            <strong>{{ getBookDisplay(issue) }}</strong>
          </td>
          <td>{{ issue.issueDate | date:'dd/MM/yyyy' }}</td>
          <td>{{ issue.estimatedReturnDate | date:'dd/MM/yyyy' }}</td>
          <td>
            <span [class]="getStatusBadgeClass(issue.status)">
              {{ issue.status }}
            </span>
          </td>
          <td>
            <span *ngIf="issue.returnDate"
              >{{ issue.returnDate | date:'dd/MM/yyyy' }}</span
            >
            <span *ngIf="!issue.returnDate" class="text-muted">-</span>
          </td>
          <td>
            <span *ngIf="getDaysOverdue(issue) > 0" class="badge bg-danger">
              {{ getDaysOverdue(issue) }} day(s) overdue
            </span>
            <span
              *ngIf="getDaysOverdue(issue) === 0 && issue.status === 'Issued'"
              class="badge bg-success"
            >
              On time
            </span>
            <span
              *ngIf="issue.status === 'Returned'"
              class="badge bg-secondary"
            >
              Returned
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="issuedBooks.length === 0 && !loading" class="alert alert-warning">
    No issued books found.
  </div>

  <!-- Pagination -->
  <app-pagination
    *ngIf="totalPages > 1"
    [currentPage]="currentPage"
    [totalPages]="totalPages"
    (pageChange)="onPageChange($event)"
  ></app-pagination>
</div>
