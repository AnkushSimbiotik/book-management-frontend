<div class="container mt-5">
  <h2>Books List</h2>

  <div class="mb-3">
    <a class="btn btn-success" routerLink="/books/create">Create Book</a>
  </div>

  <div class="row mb-3">
    <div class="col-md-12">
      <div class="input-group">
        <input
          type="text"
          class="form-control"
          [formControl]="searchService.getSearchControl()"
          placeholder="Search by title, author, or book ID..."
          appNoLeadingSpace
        />
        <button
          class="btn btn-outline-secondary"
          type="button"
          (click)="clearSearch()"
          [disabled]="!searchService.getSearchControl().value"
        >
          Clear
        </button>
      </div>
      <div
        *ngIf="searchService.getSearchControl().touched && searchService.getSearchControl().errors?.['leadingSpace']"
        class="invalid-feedback d-block"
      >
        {{ searchService.getSearchControl().errors!['leadingSpace'] }}
      </div>
    </div>
  </div>

  <div *ngIf="loading" class="alert alert-info d-flex align-items-center">
    <div class="spinner-border spinner-border-sm me-2" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    Searching books...
  </div>
  <div *ngIf="error" class="alert alert-danger">{{ error }}</div>

  <div *ngIf="searchQuery && !loading && !error" class="alert alert-info">
    <i class="bi bi-search"></i>
    Search results for "{{ searchQuery }}": {{ books.length }} book(s) found
    <button
      class="btn btn-sm btn-outline-secondary ms-2"
      (click)="clearSearch()"
    >
      Clear Search
    </button>
  </div>

  <div *ngIf="books.length === 0 && !loading && searchQuery" class="alert alert-warning">
    No books found for "{{ searchQuery }}". Try a different search term.
  </div>

  <div *ngIf="books.length > 0" class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Author</th>
          <th>Topics</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let book of books">
          <ng-container *ngIf="!isEditing(book)">
            <td>{{ book._id }}</td>
            <td>{{ book.title }}</td>
            <td>{{ book.author }}</td>
            <td>{{ getTopicNames(book.topics) }}</td>
            <td>
              <a
                [routerLink]="['/books', getBookId(book)]"
                class="btn btn-info btn-sm me-2"
                *ngIf="getBookId(book)"
                >View</a
              >
              <button
                class="btn btn-warning btn-sm me-2"
                (click)="startEdit(book)"
              >
                Edit
              </button>
              <button
                class="btn btn-danger btn-sm"
                (click)="deleteBook(getBookId(book)!)"
                *ngIf="getBookId(book)"
              >
                Delete
              </button>
            </td>
          </ng-container>

          <ng-container *ngIf="isEditing(book)">
            <td>{{ getBookId(book) }}</td>
            <td>
              <input
                type="text"
                class="form-control form-control-sm"
                [formControl]="titleControl"
                appNoLeadingSpace
                [class.is-invalid]="titleControl.invalid && titleControl.touched"
              />
              <div
                *ngIf="titleControl.hasError('required')"
                class="invalid-feedback"
              >
                Title is required
              </div>
              <div
                *ngIf="titleControl.hasError('leadingSpace')"
                class="invalid-feedback"
              >
                {{ titleControl.errors!['leadingSpace'] }}
              </div>
            </td>
            <td>
              <input
                type="text"
                class="form-control form-control-sm"
                [formControl]="authorControl"
                appNoLeadingSpace
                [class.is-invalid]="authorControl.invalid && authorControl.touched"
              />
              <div
                *ngIf="authorControl.hasError('required')"
                class="invalid-feedback"
              >
                Author is required
              </div>
              <div
                *ngIf="authorControl.hasError('leadingSpace')"
                class="invalid-feedback"
              >
                {{ authorControl.errors!['leadingSpace'] }}
              </div>
            </td>
            <td>
              <select
                class="form-select form-select-sm"
                [formControl]="topicsControl"
                multiple
                [class.is-invalid]="topicsControl.invalid && topicsControl.touched"
              >
                <option *ngFor="let topic of topics" [value]="topic.id || topic._id">
                  {{ topic.genre || 'Unknown Topic' }}
                </option>
              </select>
              <small class="text-muted">Hold Ctrl to select multiple</small>
              <div
                *ngIf="topicsControl.hasError('required')"
                class="invalid-feedback"
              >
                At least one topic is required
              </div>
            </td>
            <td>
              <button
                class="btn btn-success btn-sm me-2"
                (click)="saveEdit()"
                [disabled]="editForm.invalid"
              >
                Save
              </button>
              <button class="btn btn-secondary btn-sm" (click)="cancelEdit()">
                Cancel
              </button>
            </td>
          </ng-container>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="books.length === 0 && !loading && !searchQuery" class="alert alert-warning">
    No books found.
  </div>

  <app-pagination
    *ngIf="totalPages > 1"
    [currentPage]="currentPage"
    [totalPages]="totalPages"
    (pageChange)="onPageChange($event)"
  ></app-pagination>
</div>