<div class="container mt-5">
  <h2>Books List</h2>

  <!-- Create Book Button -->
  <div class="mb-3">
    <a class="btn btn-success" routerLink="/books/create">Create Book</a>
  </div>

  <!-- Search and Sort -->
  <div class="row mb-3">
    <div class="col-md-6">
      <div class="input-group">
        <input
          type="text"
          class="form-control"
          [(ngModel)]="searchQuery"
          (keyup.enter)="onSearch()"
          placeholder="Search books by title or author..."
        />
        <button
          class="btn btn-outline-secondary"
          type="button"
          (click)="onSearch()"
          [disabled]="loading"
        >
          <i class="bi bi-search"></i> Search
        </button>
        <button
          class="btn btn-outline-secondary"
          type="button"
          (click)="clearSearch()"
          [disabled]="!searchQuery"
        >
          Clear
        </button>
      </div>
    </div>
    <div class="col-md-6">
      <select class="form-select" [(ngModel)]="sort" (change)="onSort()">
        <option value="">Sort by</option>
        <option value="title:asc">Title (A-Z)</option>
        <option value="title:desc">Title (Z-A)</option>
        <option value="author:asc">Author (A-Z)</option>
        <option value="author:desc">Author (Z-A)</option>
        <option value="createdAt:desc">Newest First</option>
        <option value="createdAt:asc">Oldest First</option>
      </select>
    </div>
  </div>

  <!-- Loading or Error State -->
  <div *ngIf="loading" class="alert alert-info">Loading books...</div>
  <div *ngIf="error" class="alert alert-danger">{{ error }}</div>

  <!-- Search Results Feedback -->
  <div *ngIf="searchQuery && !loading && !error" class="alert alert-info">
    <i class="bi bi-search"></i>
    Search results for "{{ searchQuery }}": {{ books.length }} book(s) found
    <button
      class="btn btn-sm btn-outline-secondary ms-2"
      (click)="clearSearch()"
    >
      Clear Search
    </button>
  </div>

  <!-- Books Table -->
  <div *ngIf="books.length > 0" class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Title</th>
          <th>Author</th>
          <th>Topics</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let book of books">
          <!-- Normal View Mode -->
          <ng-container *ngIf="!isEditing(book)">
            <td>{{ book.title }}</td>
            <td>{{ book.author }}</td>
            <td>{{ getTopicNames(book.topics) }}</td>
            <td>
              <a
                [routerLink]="['/books', getBookId(book)]"
                class="btn btn-info btn-sm me-2"
                *ngIf="getBookId(book)"
                >View</a
              >
              <button
                class="btn btn-warning btn-sm me-2"
                (click)="startEdit(book)"
              >
                Edit
              </button>
              <button
                class="btn btn-danger btn-sm"
                (click)="deleteBook(getBookId(book)!)"
                *ngIf="getBookId(book)"
              >
                Delete
              </button>
            </td>
          </ng-container>

          <!-- Edit Mode -->
          <ng-container *ngIf="isEditing(book)">
            <td>
              <input
                type="text"
                class="form-control form-control-sm"
                [formControl]="titleControl"
                [class.is-invalid]="editForm.get('title')?.invalid && editForm.get('title')?.touched"
              />
              <div
                *ngIf="editForm.get('title')?.hasError('required')"
                class="invalid-feedback"
              >
                Title is required
              </div>
            </td>
            <td>
              <input
                type="text"
                class="form-control form-control-sm"
                [formControl]="authorControl"
                [class.is-invalid]="editForm.get('author')?.invalid && editForm.get('author')?.touched"
              />
              <div
                *ngIf="editForm.get('author')?.hasError('required')"
                class="invalid-feedback"
              >
                Author is required
              </div>
            </td>
            <td>
              <select
                class="form-select form-select-sm"
                [formControl]="topicsControl"
                multiple
                [class.is-invalid]="editForm.get('topics')?.invalid && editForm.get('topics')?.touched"
              >
                <option *ngFor="let topic of topics" [value]="topic.id">
                  {{ topic.genre || 'Unknown Topic' }}
                </option>
              </select>
              <small class="text-muted">Hold Ctrl to select multiple</small>
              <div
                *ngIf="editForm.get('topics')?.hasError('required')"
                class="invalid-feedback"
              >
                At least one topic is required
              </div>
            </td>
            <td>
              <button
                class="btn btn-success btn-sm me-2"
                (click)="saveEdit()"
                [disabled]="editForm.invalid"
              >
                Save
              </button>
              <button class="btn btn-secondary btn-sm" (click)="cancelEdit()">
                Cancel
              </button>
            </td>
          </ng-container>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="books.length === 0 && !loading" class="alert alert-warning">
    No books found.
  </div>

  <!-- Pagination -->
  <app-pagination
    *ngIf="totalPages > 1"
    [currentPage]="currentPage"
    [totalPages]="totalPages"
    (pageChange)="onPageChange($event)"
  ></app-pagination>
</div>
