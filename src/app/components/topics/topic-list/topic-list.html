<div class="container mt-5">
  <h2>Topics List</h2>

  <!-- Create Topic Button -->
  <div class="mb-3">
    <a class="btn btn-success" routerLink="/topics/create">Create Topic</a>
  </div>

  <!-- Search and Sort -->
  <div class="row mb-3">
    <div class="col-md-6">
      <div class="input-group">
        <input
          type="text"
          class="form-control"
          [formControl]="searchControl"
          placeholder="Search topics by genre, description, or ID..."
          appNoLeadingSpace
        />
        <button
          class="btn btn-outline-secondary"
          type="button"
          (click)="clearSearch()"
          [disabled]="!searchControl.value"
        >
          Clear
        </button>
      </div>
      <div
        *ngIf="searchControl.touched && searchControl.errors?.['leadingSpace']"
        class="invalid-feedback d-block"
      >
        {{ searchControl.errors!['leadingSpace'] }}
      </div>
    </div>
    <div class="col-md-6">
      <select class="form-select" [(ngModel)]="sort" (change)="onSort()">
        <option value="">Sort by</option>
        <option value="genre:asc">Genre (A-Z)</option>
        <option value="genre:desc">Genre (Z-A)</option>
        <option value="createdAt:desc">Newest First</option>
        <option value="createdAt:asc">Oldest First</option>
      </select>
    </div>
  </div>

  <!-- Loading or Error State -->
  <div *ngIf="loading" class="alert alert-info d-flex align-items-center">
    <div class="spinner-border spinner-border-sm me-2" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    Searching topics...
  </div>
  <div *ngIf="error" class="alert alert-danger">{{ error }}</div>

  <!-- Search Results Feedback -->
  <div *ngIf="searchQuery && !loading && !error" class="alert alert-info">
    <i class="bi bi-search"></i>
    Search results for "{{ searchQuery }}": {{ topics.length }} topic(s) found
    <button class="btn btn-sm btn-outline-secondary ms-2" (click)="clearSearch()">
      Clear Search
    </button>
  </div>

  <!-- Topics Table -->
  <div *ngIf="topics.length > 0" class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Id</th>
          <th>Genre</th>
          <th>Created At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let topic of topics">
          <ng-container *ngIf="!isEditing(topic); else editRow">
            <td>{{ topic._id }}</td>
            <td>{{ topic.genre }}</td>
            <td>{{ topic.createdAt | date:'dd/MM/yyyy' }}</td>
            <td>
              <a
                *ngIf="getTopicId(topic)"
                [routerLink]="['/topics', getTopicId(topic)]"
                class="btn btn-info btn-sm me-2"
                >View</a
              >
              <button
                *ngIf="getTopicId(topic)"
                class="btn btn-warning btn-sm me-2"
                (click)="startEdit(topic)"
              >
                Edit
              </button>
              <button
                *ngIf="getTopicId(topic)"
                class="btn btn-danger btn-sm"
                (click)="deleteTopic(getTopicId(topic))"
              >
                Delete
              </button>
              <span *ngIf="!getTopicId(topic)" class="text-muted"
                >No ID available</span
              >
            </td>
          </ng-container>
          <ng-template #editRow>
            <td>{{ topic._id }}</td>
            <td>
              <input
                class="form-control form-control-sm"
                [formControl]="genreControl"
                [class.is-invalid]="genreControl.invalid && genreControl.touched"
              />
              <div *ngIf="genreControl.hasError('required')" class="invalid-feedback">
                Genre is required
              </div>
            </td>
            <td>
              <input
                class="form-control form-control-sm"
                [formControl]="descriptionControl"
                [class.is-invalid]="descriptionControl.invalid && descriptionControl.touched"
              />
              <div *ngIf="descriptionControl.hasError('required')" class="invalid-feedback">
                Description is required
              </div>
            </td>
            <td>
              <button
                class="btn btn-success btn-sm me-2"
                (click)="saveEdit()"
                [disabled]="editForm.invalid"
              >
                Save
              </button>
              <button class="btn btn-secondary btn-sm" (click)="cancelEdit()">
                Cancel
              </button>
            </td>
          </ng-template>
        </tr>
      </tbody>
    </table>
  </div>
  <div *ngIf="topics.length === 0 && !loading && searchQuery" class="alert alert-warning">
    No topics found for "{{ searchQuery }}". Try a different search term.
  </div>
  <div *ngIf="topics.length === 0 && !loading && !searchQuery" class="alert alert-warning">
    No topics found.
  </div>

  <!-- Pagination -->
  <app-pagination
    *ngIf="totalPages > 1"
    [currentPage]="currentPage"
    [totalPages]="totalPages"
    (pageChange)="onPageChange($event)"
  ></app-pagination>
</div>